<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>평화 퍼즐 만들기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 960px;
        }
        /* 인쇄 시에만 적용되는 스타일 */
        @media print {
            body {
                background-color: white;
            }
            .no-print {
                display: none;
            }
            #app {
                display: none;
            }
            #print-area {
                display: block !important;
                width: 29.7cm; /* A4 가로 너비 */
                height: 21cm; /* A4 가로 높이 */
                margin: 0 auto;
                position: relative;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            #hiddenCanvas.print-canvas {
                display: block !important;
                max-width: 100%;
                max-height: 100%;
            }

            @page {
                size: a4 landscape;
                margin: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- 메인 애플리케이션 컨테이너 -->
    <div id="app" class="container mx-auto bg-white p-8 rounded-3xl shadow-2xl space-y-8">
        <h1 class="text-4xl font-bold text-center text-blue-700">우리 반 평화 퍼즐 만들기</h1>
        <p class="text-center text-gray-600">긴 문장으로 퍼즐을 만들어 보세요. 원하는 조각 수를 설정하면 각 조각에 번호가 표시되어 활동을 더 재미있게 만들어 줍니다.</p>

        <!-- 제어 패널 -->
        <div class="no-print bg-gray-50 p-6 rounded-2xl shadow-inner space-y-4">
            <div>
                <label for="puzzleText" class="block text-sm font-medium text-gray-700">퍼즐 문구:</label>
                <input type="text" id="puzzleText" value="우리 반의 평화는 우리 모두의 협력으로 만들어집니다" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
            </div>
            <div>
                <label for="pieceCount" class="block text-sm font-medium text-gray-700">조각 수 (최소 4, 최대 64):</label>
                <input type="number" id="pieceCount" value="28" min="4" max="64" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
            </div>
            <div class="flex justify-center space-x-4">
                <button id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">퍼즐 생성하기</button>
                <button id="printBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">인쇄용 퍼즐 미리보기</button>
            </div>
        </div>
        
        <!-- 완성된 퍼즐 미리보기 (절취선 포함) -->
        <div id="originalContainer" class="mt-8 border-t pt-8">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">완성된 퍼즐 (절취선 포함)</h2>
            <div class="flex justify-center">
                <img id="originalImage" src="" alt="전체 퍼즐 그림" class="rounded-lg shadow-xl" style="display: none;">
            </div>
        </div>

        <!-- 이미지 생성을 위한 숨겨진 캔버스 -->
        <canvas id="hiddenCanvas" class="hidden"></canvas>
    </div>

    <!-- 인쇄 전용 영역 (이제 캔버스만 포함) -->
    <div id="print-area" class="hidden"></div>

    <script>
        window.onload = function() {
            const generateBtn = document.getElementById('generateBtn');
            const printBtn = document.getElementById('printBtn');
            const puzzleTextEl = document.getElementById('puzzleText');
            const pieceCountEl = document.getElementById('pieceCount');
            const originalImageEl = document.getElementById('originalImage');
            const hiddenCanvas = document.getElementById('hiddenCanvas');
            const ctx = hiddenCanvas.getContext('2d');
            const printArea = document.getElementById('print-area');
            
            // 커스텀 모달 창을 띄우는 함수
            function showModal(message) {
                const modalHtml = `
                    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
                        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto">
                            <h3 class="text-lg font-bold mb-4">알림</h3>
                            <p class="text-gray-700 mb-6">${message}</p>
                            <div class="flex justify-end">
                                <button onclick="document.getElementById('customModal').remove()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full">확인</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }

            // 퍼즐 이미지를 생성하는 핵심 함수
            function generatePuzzle() {
                const puzzleText = puzzleTextEl.value || "우리 반의 평화는 우리 모두의 협력으로 만들어집니다";
                const pieceCount = parseInt(pieceCountEl.value, 10);

                if (isNaN(pieceCount) || pieceCount < 4 || pieceCount > 64) {
                    showModal('조각 수는 4에서 64 사이의 값으로 입력해주세요.');
                    return;
                }

                originalImageEl.style.display = 'none';

                // A4 가로 비율(297mm x 210mm)에 맞춰 캔버스 크기 계산
                const aspect_ratio = 297 / 210;
                const canvasHeight = 1000;
                const canvasWidth = canvasHeight * aspect_ratio;
                
                hiddenCanvas.width = canvasWidth;
                hiddenCanvas.height = canvasHeight;
                
                // 텍스트 줄바꿈 및 폰트 크기 계산
                let fontSize = 200;
                let textLines = [];
                let attempts = 0;
                const maxLineLength = canvasWidth - 50;

                while(true) {
                    ctx.font = `${fontSize}px Jua, sans-serif`;
                    let words = puzzleText.split(' ');
                    let line = '';
                    textLines = [];
                    for(let i = 0; i < words.length; i++) {
                        let testLine = line + words[i] + ' ';
                        if (ctx.measureText(testLine).width > maxLineLength && line.length > 0) {
                            textLines.push(line.trim());
                            line = words[i] + ' ';
                        } else {
                            line = testLine;
                        }
                    }
                    textLines.push(line.trim());

                    if ((textLines.length * (fontSize * 1.2)) <= canvasHeight * 0.9 && fontSize > 10) {
                        break;
                    }
                    fontSize -= 5;
                    attempts++;
                    if (attempts > 50) {
                        break;
                    }
                }
                
                // 배경 그리기
                ctx.fillStyle = '#4a90e2';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                // 텍스트 그리기
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const lineHeight = fontSize * 1.2;
                const totalTextHeight = textLines.length * lineHeight;
                const startY = (canvasHeight - totalTextHeight) / 2 + lineHeight / 2;
                
                for (let i = 0; i < textLines.length; i++) {
                    ctx.fillText(textLines[i], canvasWidth / 2, startY + i * lineHeight);
                }

                // 절취선 그리기: 조각 수에 맞춰 행과 열을 계산
                const cols = Math.ceil(Math.sqrt(pieceCount));
                const rows = Math.ceil(pieceCount / cols);
                const pieceWidth = canvasWidth / cols;
                const pieceHeight = canvasHeight / rows;

                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.setLineDash([10, 5]); // 점선 스타일 설정

                // 가로 절취선
                for (let i = 1; i < rows; i++) {
                    ctx.beginPath();
                    ctx.moveTo(0, i * pieceHeight);
                    ctx.lineTo(canvasWidth, i * pieceHeight);
                    ctx.stroke();
                }

                // 세로 절취선
                for (let i = 1; i < cols; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i * pieceWidth, 0);
                    ctx.lineTo(i * pieceWidth, canvasHeight);
                    ctx.stroke();
                }

                // 완성된 이미지 보여주기
                const imageDataUrl = hiddenCanvas.toDataURL();
                originalImageEl.src = imageDataUrl;
                originalImageEl.style.display = 'block';
            }
            
            // 인쇄 미리보기를 보여주는 함수
            function showPrintPreview() {
                // 인쇄를 위해 캔버스를 인쇄 영역으로 이동
                printArea.appendChild(hiddenCanvas);
                hiddenCanvas.classList.add('print-canvas');

                // 본문 숨기기
                document.getElementById('app').style.display = 'none';

                window.print();
                
                // 인쇄창이 닫힌 후 원래 화면으로 복귀
                setTimeout(() => {
                    hiddenCanvas.classList.remove('print-canvas');
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('originalContainer').appendChild(hiddenCanvas);
                    
                }, 500);
            }

            window.showModal = showModal;

            generateBtn.addEventListener('click', generatePuzzle);
            printBtn.addEventListener('click', showPrintPreview);

            // 페이지 로드 시 초기 퍼즐 생성
            generatePuzzle();
        };
    </script>
</body>
</html>
