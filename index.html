<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>평화 퍼즐 만들기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 960px;
        }
        .puzzle-piece-container {
            position: relative;
            display: inline-block;
        }
        @media print {
            body {
                background-color: white;
            }
            .no-print {
                display: none;
            }
            #app, #puzzleContainer, #puzzlePieces, #originalContainer {
                display: none;
            }
            #print-area {
                display: block !important;
                width: 21cm; /* A4 width */
                height: 29.7cm; /* A4 height */
                margin: 0 auto;
                position: relative;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto bg-white p-8 rounded-3xl shadow-2xl space-y-8">
        <h1 class="text-4xl font-bold text-center text-blue-700">우리 반 평화 퍼즐 만들기</h1>
        <p class="text-center text-gray-600">긴 문장으로 퍼즐을 만들어 보세요. 원하는 조각 수를 설정하면 각 조각에 번호가 표시되어 활동을 더 재미있게 만들어 줍니다.</p>

        <!-- Control Panel -->
        <div class="no-print bg-gray-50 p-6 rounded-2xl shadow-inner space-y-4">
            <div>
                <label for="puzzleText" class="block text-sm font-medium text-gray-700">퍼즐 문구:</label>
                <input type="text" id="puzzleText" value="우리 반의 평화는 우리 모두의 협력으로 만들어집니다" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
            </div>
            <div>
                <label for="pieceCount" class="block text-sm font-medium text-gray-700">조각 수 (최소 4, 최대 64):</label>
                <input type="number" id="pieceCount" value="28" min="4" max="64" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
            </div>
            <div class="flex justify-center space-x-4">
                <button id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">퍼즐 생성하기</button>
                <button id="printBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">인쇄용 퍼즐 미리보기</button>
            </div>
        </div>

        <!-- Puzzle Display Area (for on-screen preview) -->
        <div id="puzzleContainer" class="mt-8">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">퍼즐 조각 미리보기</h2>
            <div id="puzzlePieces" class="flex flex-wrap justify-center gap-4">
                <!-- Puzzle pieces will be dynamically added here -->
            </div>
        </div>
        
        <!-- Original Image Reference (for on-screen preview) -->
        <div id="originalContainer" class="mt-8 border-t pt-8">
            <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">전체 그림 (참고용)</h2>
            <div class="flex justify-center">
                <img id="originalImage" src="" alt="전체 퍼즐 그림" class="rounded-lg shadow-xl" style="display: none;">
            </div>
        </div>

        <!-- Hidden canvas for image generation -->
        <canvas id="hiddenCanvas" class="hidden"></canvas>
    </div>

    <!-- Print Area -->
    <div id="print-area" class="hidden">
        <div class="flex justify-center">
            <div class="relative inline-block" id="printable-image-container">
                <img id="printableImage" src="" alt="인쇄용 퍼즐 그림" style="width: 100%; height: auto;">
                <div id="cut-lines-container" class="absolute inset-0"></div>
            </div>
        </div>
    </div>

    <script>
        window.onload = function() {
            const generateBtn = document.getElementById('generateBtn');
            const printBtn = document.getElementById('printBtn');
            const puzzleTextEl = document.getElementById('puzzleText');
            const pieceCountEl = document.getElementById('pieceCount');
            const puzzlePiecesEl = document.getElementById('puzzlePieces');
            const originalImageEl = document.getElementById('originalImage');
            const hiddenCanvas = document.getElementById('hiddenCanvas');
            const ctx = hiddenCanvas.getContext('2d');
            const printableImageEl = document.getElementById('printableImage');
            const cutLinesContainer = document.getElementById('cut-lines-container');
            const printArea = document.getElementById('print-area');

            const canvasWidth = 1200;
            const lineHeight = 160;
            let currentPieces = [];

            function generatePuzzle() {
                const puzzleText = puzzleTextEl.value || "우리 반의 평화는 우리 모두의 협력으로 만들어집니다";
                const pieceCount = parseInt(pieceCountEl.value, 10);

                if (isNaN(pieceCount) || pieceCount < 4 || pieceCount > 64) {
                    showModal('조각 수는 4에서 64 사이의 값으로 입력해주세요.');
                    return;
                }

                puzzlePiecesEl.innerHTML = '';
                originalImageEl.style.display = 'none';

                ctx.font = `150px Jua, sans-serif`;
                
                function getWrappedLines(text, maxWidth, lineHeight) {
                    const words = text.split(' ');
                    let line = '';
                    let lines = [];
                    
                    for(let n = 0; n < words.length; n++) {
                        let testLine = line + words[n] + ' ';
                        let metrics = ctx.measureText(testLine);
                        let testWidth = metrics.width;
                        if (testWidth > maxWidth && n > 0) {
                            lines.push(line);
                            line = words[n] + ' ';
                        } else {
                            line = testLine;
                        }
                    }
                    lines.push(line);
                    return lines;
                }

                const lines = getWrappedLines(puzzleText, canvasWidth - 50, lineHeight);
                const canvasHeight = lines.length * lineHeight;
                hiddenCanvas.width = canvasWidth;
                hiddenCanvas.height = canvasHeight;

                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                ctx.fillStyle = '#4a90e2';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = `150px Jua, sans-serif`;

                let startY = canvasHeight / 2 - ((lines.length - 1) * lineHeight / 2);
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i].trim(), canvasWidth / 2, startY + i * lineHeight);
                }

                const imageDataUrl = hiddenCanvas.toDataURL();
                originalImageEl.src = imageDataUrl;
                originalImageEl.style.display = 'block';

                const cols = Math.ceil(Math.sqrt(pieceCount));
                const rows = Math.ceil(pieceCount / cols);
                const pieceWidth = canvasWidth / cols;
                const pieceHeight = canvasHeight / rows;
                currentPieces = { cols, rows, pieceWidth, pieceHeight, image: imageDataUrl };

                for (let i = 0; i < pieceCount; i++) {
                    const col = i % cols;
                    const row = Math.floor(i / cols);

                    const pieceCanvas = document.createElement('canvas');
                    pieceCanvas.width = pieceWidth;
                    pieceCanvas.height = pieceHeight;
                    const pieceCtx = pieceCanvas.getContext('2d');

                    pieceCtx.drawImage(
                        hiddenCanvas,
                        col * pieceWidth,
                        row * pieceHeight,
                        pieceWidth,
                        pieceHeight,
                        0,
                        0,
                        pieceWidth,
                        pieceHeight
                    );

                    const pieceDiv = document.createElement('div');
                    pieceDiv.className = 'puzzle-piece bg-white p-2 rounded-lg shadow-md flex flex-col items-center justify-center space-y-2';
                    pieceDiv.style.width = `${100 / cols - 2}%`;
                    pieceDiv.style.maxWidth = `250px`;

                    const pieceImg = document.createElement('img');
                    pieceImg.src = pieceCanvas.toDataURL();
                    pieceImg.alt = `퍼즐 조각 ${i + 1}`;
                    pieceImg.className = 'rounded-md border border-gray-200';

                    const pieceNumber = document.createElement('div');
                    pieceNumber.textContent = `조각 ${i + 1} / ${pieceCount}`;
                    pieceNumber.className = 'text-gray-700 font-bold text-sm bg-white bg-opacity-70 px-2 py-1 rounded-full absolute bottom-2 right-2';

                    pieceDiv.appendChild(pieceImg);
                    pieceDiv.appendChild(pieceNumber);
                    puzzlePiecesEl.appendChild(pieceDiv);
                }
            }
            
            function showPrintPreview() {
                const { cols, rows, pieceWidth, pieceHeight, image } = currentPieces;

                // Set image source for printing
                printableImageEl.src = image;

                // Clear previous cut lines
                cutLinesContainer.innerHTML = '';

                // Create horizontal cut lines
                for (let i = 1; i < rows; i++) {
                    const line = document.createElement('div');
                    line.style.cssText = `
                        position: absolute;
                        top: ${i * (100 / rows)}%;
                        left: 0;
                        width: 100%;
                        height: 0;
                        border-top: 2px dashed black;
                    `;
                    cutLinesContainer.appendChild(line);
                }

                // Create vertical cut lines
                for (let i = 1; i < cols; i++) {
                    const line = document.createElement('div');
                    line.style.cssText = `
                        position: absolute;
                        left: ${i * (100 / cols)}%;
                        top: 0;
                        height: 100%;
                        width: 0;
                        border-left: 2px dashed black;
                    `;
                    cutLinesContainer.appendChild(line);
                }
                
                // Show only the print area
                document.getElementById('app').style.display = 'none';
                printArea.style.display = 'block';

                // Automatically open print dialog
                window.print();
                
                // Hide print area after printing (or canceling)
                // Using a timeout to ensure the print dialog has time to open
                setTimeout(() => {
                    document.getElementById('app').style.display = 'block';
                    printArea.style.display = 'none';
                }, 500);
            }

            // A simple modal for user alerts, replacing the native alert()
            function showModal(message) {
                const modalHtml = `
                    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
                        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-auto">
                            <h3 class="text-lg font-bold mb-4">알림</h3>
                            <p class="text-gray-700 mb-6">${message}</p>
                            <div class="flex justify-end">
                                <button onclick="document.getElementById('customModal').remove()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full">확인</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            window.showModal = showModal;

            generateBtn.addEventListener('click', generatePuzzle);
            printBtn.addEventListener('click', showPrintPreview);

            generatePuzzle();
        };
    </script>
</body>
</html>
